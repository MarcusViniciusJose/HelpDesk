CREATE DATABASE hdaero;
USE hdaero;

-- Tabela de Usuários
CREATE TABLE usuario (
    id_usuario INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(50) NOT NULL UNIQUE,
    login VARCHAR(50) NOT NULL UNIQUE,
    senha VARCHAR(255) NOT NULL,
    tipo ENUM('cliente', 'atendente', 'gerente', 'admin') NOT NULL,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    foto VARCHAR(255) DEFAULT NULL
);

-- Tabela de Departamentos
CREATE TABLE departamento (
    id_departamento INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL UNIQUE,
    descricao TEXT NOT NULL
);

-- Tabela de Categorias
CREATE TABLE categoria (
    id_categoria INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL UNIQUE,
    descricao TEXT NOT NULL
);

-- Tabela de Chamados
CREATE TABLE chamado (
    id_chamado INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario_criador INT NOT NULL,
    id_usuario_atendente INT DEFAULT NULL,  -- O chamado pode não ter um atendente no início
    id_departamento INT NOT NULL,
    id_categoria INT NOT NULL,
    titulo VARCHAR(150) NOT NULL,
    descricao TEXT NOT NULL,
    status_chamado ENUM('aberto', 'em andamento', 'fechado') NOT NULL DEFAULT 'aberto',
    prioridade ENUM('baixa', 'média', 'alta', 'crítica') NOT NULL DEFAULT 'média',
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario_criador) REFERENCES usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_usuario_atendente) REFERENCES usuario(id_usuario) ON DELETE SET NULL,
    FOREIGN KEY (id_departamento) REFERENCES departamento(id_departamento) ON DELETE CASCADE,
    FOREIGN KEY (id_categoria) REFERENCES categoria(id_categoria) ON DELETE CASCADE
);

-- Tabela de Histórico de Chamados
CREATE TABLE historico_chamado (
    id_historico INT AUTO_INCREMENT PRIMARY KEY,
    id_chamado INT NOT NULL,
    id_usuario INT NOT NULL,
    descricao TEXT NOT NULL,
    alterado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_chamado) REFERENCES chamado(id_chamado) ON DELETE CASCADE,
    FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario) ON DELETE CASCADE
);

-- Tabela de Anexos
CREATE TABLE anexo (
    id_anexo INT AUTO_INCREMENT PRIMARY KEY,
    id_chamado INT NOT NULL,
    nome_arquivo VARCHAR(255) NOT NULL,
    caminho_arquivo VARCHAR(255) NOT NULL,
    adicionado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_chamado) REFERENCES chamado(id_chamado) ON DELETE CASCADE
);

USE hdaero;

-- Inserindo usuários (clientes, atendentes, gerente e admin)
INSERT INTO usuario (nome, email, login, senha, tipo, foto) VALUES
('Carlos Silva', 'carlos@email.com', 'carlos_s', 'senha123', 'cliente', NULL),
('Mariana Souza', 'mariana@email.com', 'mariana_s', 'senha123', 'cliente', NULL),
('João Pereira', 'joao@email.com', 'joao_p', 'senha123', 'atendente', NULL),
('Fernanda Lima', 'fernanda@email.com', 'fernanda_l', 'senha123', 'atendente', NULL),
('Roberto Mendes', 'roberto@email.com', 'roberto_m', 'senha123', 'gerente', NULL),
('Ana Beatriz', 'ana@email.com', 'ana_b', 'senha123', 'admin', NULL);

-- Inserindo departamentos
INSERT INTO departamento (nome, descricao) VALUES
('TI', 'Responsável pelo suporte técnico e infraestrutura.'),
('RH', 'Departamento de Recursos Humanos e gestão de pessoas.'),
('Financeiro', 'Responsável pela administração financeira.');

-- Inserindo categorias
INSERT INTO categoria (nome, descricao) VALUES
('Problema de Hardware', 'Defeitos ou mau funcionamento de equipamentos.'),
('Problema de Software', 'Erro ou falha em programas e sistemas.'),
('Rede', 'Problemas de conexão com a internet ou servidores.');

-- Inserindo chamados (clientes abrindo chamados)
INSERT INTO chamado (id_usuario_criador, id_usuario_atendente, id_departamento, id_categoria, titulo, descricao, status_chamado, prioridade) VALUES
(1, NULL, 1, 1, 'Computador não liga', 'Meu computador parou de ligar de repente.', 'aberto', 'alta'),
(2, 3, 1, 2, 'Erro ao acessar sistema ERP', 'O sistema ERP está apresentando erro ao tentar fazer login.', 'em andamento', 'média'),
(1, 4, 1, 3, 'Wi-Fi desconectando', 'A conexão Wi-Fi cai a cada 10 minutos.', 'aberto', 'média'),
(2, NULL, 3, 2, 'Erro ao gerar relatório financeiro', 'Não consigo exportar um relatório importante.', 'aberto', 'crítica');

-- Inserindo histórico de chamados (atualizações feitas nos chamados)
INSERT INTO historico_chamado (id_chamado, id_usuario, descricao) VALUES
(2, 3, 'Chamado atribuído a João Pereira.'),
(2, 3, 'Verifiquei que há um problema com o banco de dados.'),
(3, 4, 'Realizei testes na rede e identifiquei uma interferência.'),
(4, 5, 'Encaminhado para análise da equipe financeira.');

-- Inserindo anexos em chamados
INSERT INTO anexo (id_chamado, nome_arquivo, caminho_arquivo) VALUES
(2, 'erro_sistema.png', '/uploads/erro_sistema.png'),
(3, 'teste_rede.log', '/uploads/teste_rede.log'),
(4, 'relatorio_bug.docx', '/uploads/relatorio_bug.docx');

